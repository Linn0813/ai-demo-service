"""LLM提示词构建工具"""
from __future__ import annotations


def build_generation_prompt(requirement_doc: str) -> str:
    """构建测试用例生成的提示词。"""

    return f"""你是一位有着10年测试经验的资深测试工程师。请仔细阅读以下需求文档，并严格按照文档内容生成全面的测试用例。

【任务要求】
根据以下需求文档，生成测试用例。必须严格按照需求文档中的实际功能点生成。

【需求文档】
{requirement_doc}

【生成要求】
1. 仔细分析需求文档，识别所有功能模块和功能点
2. 为每个功能模块生成测试用例，覆盖：
   - UI元素测试（按钮、字段、显示等）
   - 交互逻辑测试（按钮状态、弹窗逻辑、流程跳转等）
   - 业务规则测试（不同条件对应不同行为等）
   - 边界条件测试（字符限制、数值范围等）
3. 对于需求文档中提到的每个具体功能、按钮、字段、流程、规则、限制，都要有对应的测试用例
4. 根据需求文档的复杂程度，生成足够全面的测试用例，确保不遗漏任何功能点
5. **所有输出必须使用简体中文，不得出现繁体字或「」等繁体标点**
6. **禁止臆造需求文档中未出现的功能、文案或页面位置**
7. **所有测试步骤必须是App端可执行的实际操作，禁止出现“登录后台”“查看数据库”“手动投放”等后台或运营动作**
8. **每个测试用例的 steps 至少包含3条明确操作步骤，且每一步都要描述具体交互**
9. **避免写入无法执行的描述（例如“等待7天”），遇到时改写为可执行的验证步骤或拆分为前置条件**

【输出格式要求】
**重要：只输出JSON格式，不要包含任何其他文字说明！**

每个测试用例必须包含以下字段：
- case_name: 测试用例名称（必须与需求文档中的功能点对应）
- description: 用例描述（详细说明测试目的，引用需求文档中的具体内容）
- preconditions: 前置条件（基于需求文档中的前置要求）
- steps: 测试步骤（数组格式，每个步骤一行，必须与需求文档中的操作流程一致）
- expected_result: 预期结果（必须与需求文档中的预期行为一致）
- priority: 优先级（high/medium/low）

【输出格式示例】
{{
  "test_cases": [
    {{
      "case_name": "用例名称",
      "description": "用例描述",
      "preconditions": "前置条件",
      "steps": ["步骤1", "步骤2", "步骤3"],
      "expected_result": "预期结果",
      "priority": "high"
    }}
  ]
}}

【重要提醒】
1. 只生成需求文档中明确提到的功能
2. 必须生成足够多的测试用例，覆盖所有功能点
3. **只输出JSON，不要包含任何其他文字说明**
4. **确保JSON格式正确，可以直接解析**"""


def build_module_extraction_prompt(requirement_doc: str) -> str:
    """构建功能模块提取的提示词。"""

    return f"""你是一个JSON输出工具。你的任务是从需求文档中提取功能模块，并以JSON格式输出结果。

**任务要求：**
1. 仔细阅读以下需求文档
2. 识别并提取所有功能模块
3. **只输出JSON，不要输出任何其他内容**

**⚠️ 严格规则：**
- **严禁臆造模块**：只能提取需求文档中明确提到的模块名称，绝对不能自行创造、概括或推断模块名称
- **必须验证**：提取的每个模块名称，都必须在需求文档中找到对应的明确文字提及
- 如果文档中没有明确提到某个模块，就不要提取该模块
- **禁止输出代码、解释、说明或任何非JSON内容**
- **你的响应必须是一个JSON对象，从 {{ 开始，到 }} 结束，中间不要有任何其他文字**

需求文档：
{requirement_doc}

**功能模块定义：**
功能模块是指需求文档中相对独立、完整的功能单元，通常包含：
- 一个主要功能或业务流程
- 相关的UI组件、交互逻辑、业务规则
- 相关的数据操作、状态管理

**提取要求：**
1. 识别文档中的**所有**主要功能模块，每个模块应该是一个相对完整的页面、弹窗或业务流程
2. **禁止使用泛化的模块名称**（如"主要功能模块"、"核心模块"、"通用模块"等），必须使用文档中明确提到的具体模块名称
3. 如果文档中明确提到了多个独立的模块（即使它们有相似的命名模式），也必须作为独立的模块分别提取，不要合并
4. 仔细扫描文档，找出所有明确命名的模块（如果文档中提到了多个具有相似命名模式的模块，每个都应该作为独立模块提取，不要合并）
5. **禁止拆分模块内部的题目、字段或选项**，例如"血压测量结果""血压测量操作流程"都属于"血压洞察NPS"，不要单独输出
6. **禁止将状态、条件、场景识别为独立模块**，例如"存在有效数据"、"无有效数据"、"存在数据"、"无工作日数据"等都是状态或条件，应该归属于"状态判断条件"或"判断条件"等模块，不要单独提取
7. **重要：独立的功能单元应该作为独立模块提取**
   - 如果文档中有独立的章节标题（如"详情信息半弹窗"、"工作日和非工作日设置"、"详情说明半弹窗"、"算法规则定义"等），即使它们属于某个更大的功能模块，也应该作为独立的模块提取
   - 只有当某个功能明确是另一个模块的子功能（如"提交按钮"、"确认弹窗"等）时，才应该归入主模块
   - 如果文档中某个功能有独立的章节标题和详细描述，应该作为独立模块提取
   - **特殊情况**：如果文档非常简单，只有一个主要功能且没有独立的子章节标题，则只提取这一个模块即可
8. 每个模块应该包含足够的内容，能够独立进行测试用例生成
9. **重要**：仔细检查文档的每个章节，确保提取了文档中明确提到的所有具体功能模块，不要遗漏，也不要使用泛化的名称
   - 如果文档只有一个模块，就只提取一个模块
   - 如果文档有多个模块，就提取所有模块
10. **特别注意**：优先提取文档中的章节标题（如"5.2 社交时差"、"详情信息半弹窗"、"工作日和非工作日设置"、"详情说明半弹窗"、"算法规则定义"等），这些通常是主要功能模块，应该作为独立模块提取

**重要要求：**
- **严格禁止臆造模块**：所有模块名称必须直接来自需求文档中明确提到的名称，不能自行创造或概括
- **模块名称必须来自文档**：如果文档中没有明确提到某个模块名称，就不要提取该模块
- 使用简体中文描述模块名称，不要使用繁体字或「」等繁体标点
- 模块名称应该清晰、简洁，能够概括模块的主要功能
- 不要遗漏需求文档中的主要功能模块
- 每个模块必须提供定位线索，帮助程序找到相关原文
- **验证要求**：提取的每个模块名称，都必须在需求文档中能够找到对应的明确提及

**关键词提取要求：**
- keywords：提供2-4个核心关键词，这些关键词必须是文档中真实存在的短语，用于精确定位原文
- 避免过于泛化的词语，优先选择具体的描述性词语
- exact_phrases：提供1-2个文档中的确切短语或句子，这些短语必须逐字来自文档原文，如果找不到原文中的原句，就不要提供
- section_hint：简短的章节名称或上下文线索（可选）

**质量校验：**
- 请优先提取文档章节或标题中的模块（例如“全局NPS”“生理期NPS”“AI Partner”），确保这些模块全部出现
- 如果一个名称在文档中多次出现，只输出一次模块
- 每个模块的 `exact_phrases` 和 `keywords` 必须源自原文对应段落，用于帮助定位原文

**重要格式要求：**
- 必须使用双引号，不要使用单引号
- 字符串中的特殊字符要正确转义
- 确保JSON格式完全正确

**输出格式要求：**
{{
  "function_modules": [
    {{
      "name": "模块名称（必须来自文档）",
      "description": "模块描述",
      "keywords": ["关键词1", "关键词2"],
      "section_hint": "章节提示",
      "exact_phrases": ["文档中的确切短语"]
    }}
  ]
}}

**⚠️ 严格输出要求（必须遵守）：**
1. **只输出JSON格式，绝对不要包含任何解释、说明、代码示例或其他文字**
2. **不要输出"你的问题涉及到..."、"我将尝试..."、"以下是一个示例"等任何解释性文字**
3. **不要输出任何代码块、代码示例或编程指导**
4. **直接输出JSON对象，从 {{ 开始，到 }} 结束，中间只有JSON内容**
5. **如果无法提取模块，输出：{{ "function_modules": [] }}**
6. **禁止输出任何非JSON内容，包括markdown代码块标记、解释文字、代码示例等**

**现在开始输出JSON（只输出JSON，不要其他内容）：**"""


def build_function_point_extraction_prompt(module_name: str, module_content: str) -> str:
    """构建功能点提取的提示词（用于在模块内识别子功能点）。"""

    return f"""你是一个JSON输出工具。你的任务是从功能模块的需求文档中提取子功能点，并以JSON格式输出结果。

**任务要求：**
1. 仔细阅读以下功能模块的需求文档
2. 识别并提取该模块内的所有子功能点
3. **只输出JSON，不要输出任何其他内容**

**功能模块：**
{module_name}

**模块需求文档：**
{module_content}

**功能点定义：**
功能点是指模块内的具体功能、操作、状态或规则，例如：
- 具体的按钮、字段、UI元素
- 具体的交互逻辑、流程步骤
- 具体的业务规则、判断条件
- 具体的状态、场景、异常情况

**提取要求：**
1. 仔细分析模块需求文档，识别所有子功能点
2. **禁止使用泛化的功能点名称**（如"主要功能"、"核心功能"、"通用功能"等），必须使用文档中明确提到的具体功能点名称
3. 每个功能点应该是一个相对独立、可测试的功能单元
4. 如果模块内容简单（少于3个明确的功能点），可以只提取1-2个主要功能点
5. **严格禁止臆造功能点**：所有功能点名称必须直接来自需求文档中明确提到的内容
6. 使用简体中文描述功能点名称，不要使用繁体字或「」等繁体标点

**关键词提取要求：**
- keywords：提供2-3个核心关键词，这些关键词必须是文档中真实存在的短语
- exact_phrases：提供1个文档中的确切短语或句子，用于定位原文

**输出格式要求：**
{{
  "function_points": [
    {{
      "name": "功能点名称（必须来自文档）",
      "description": "功能点描述",
      "keywords": ["关键词1", "关键词2"],
      "exact_phrases": ["文档中的确切短语"]
    }}
  ]
}}

**⚠️ 严格输出要求（必须遵守）：**
1. **只输出JSON格式，绝对不要包含任何解释、说明或其他文字**
2. **直接输出JSON对象，从 {{ 开始，到 }} 结束，中间只有JSON内容**
3. **如果无法提取功能点，输出：{{ "function_points": [] }}**
4. **禁止输出任何非JSON内容**

**现在开始输出JSON（只输出JSON，不要其他内容）：**"""
